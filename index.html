<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Generador de Certificados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        #certificado-template {
            width: 800px; padding: 50px; border: 10px double #2c3e50;
            text-align: center; background: white; display: none; position: absolute; left: -9999px;
        }
        .cert-title { font-size: 40px; color: #2c3e50; font-weight: bold; }
        .table-container { margin-top: 20px; }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="card shadow">
        <div class="card-body">
            <h2 class="text-center mb-4">Descarga tu Certificado</h2>
            <div class="input-group mb-3">
                <input type="text" id="cedula" class="form-control" placeholder="Ingrese su cédula">
                <button class="btn btn-primary" onclick="buscarCursos()">Buscar Cursos</button>
            </div>

            <div class="table-container">
                <table class="table table-hover d-none" id="tabla-resultados">
                    <thead class="table-dark">
                        <tr>
                            <th>Curso</th>
                            <th>Fecha</th>
                            <th>Horas</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpo-tabla"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="certificado-template">
    <h1 class="cert-title">LA SOCIEDAD ANTIOQUEÑA DE </h1>
    <h1 class="cert-title">ANESTESIOLOGÍA Y REANIMACIÓN </h1>
    <h1 class="cert-title">SADEA</h1>
    
    <p class="mt-4">Filial de la Sociedad Antioqueña de AnestesiologÍa y ReanimaciÓn S.C.A.R.E.</p>
    <p>Certifica que:</p>
    <h2 id="pdf-nombre" style="text-transform: uppercase; color: #e67e22;"></h2>
   
    <h3 id="pdf-detalles"></h3>
    <p><strong>Fecha:</strong> <span id="pdf-fecha"></span></p>
    <div class="mt-5" style="display: flex; justify-content: space-around;">
        <div>
            <p><strong>PRESIDENTE</strong></p>
            <p id="pdf-capacitador" style="border-top: 1px solid #000; padding-top: 5px;"></p>
        </div>
        <div>
            <p><strong>VOCAL ACADEMICO</strong></p>
            <p id="pdf-capacitador" style="border-top: 1px solid #000; padding-top: 5px;"></p>
        </div>
    </div>
</div>

<script>
    // REEMPLAZA ESTA URL con la de tu Google Apps Script
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyDUMu6PrfkGpyzawARhS6SCz5gkaiWlLa1auyKj71XVj77iD-D4XVz9Oc7Ywn_Uhk/exec";

    async function buscarCursos() {
        const cedula = document.getElementById('cedula').value;
        if (!cedula) return alert("Por favor ingresa una cédula");

        try {
            const resp = await fetch(`${WEB_APP_URL}?cedula=${cedula}`);
            const datos = await resp.json();
            
            const tabla = document.getElementById('tabla-resultados');
            const cuerpo = document.getElementById('cuerpo-tabla');
            cuerpo.innerHTML = "";

            if (datos.length === 0) {
                alert("No se encontraron registros");
                tabla.classList.add('d-none');
                return;
            }

            datos.forEach(item => {
                const fila = `<tr>
                    <td>${item.curso}</td>
                    <td>${item.fecha}</td>
                    <td>${item.horas}</td>
                    <td><button class="btn btn-sm btn-success" onclick='generarPDF(${JSON.stringify(item)})'>Descargar</button></td>
                </tr>`;
                cuerpo.innerHTML += fila;
            });
            tabla.classList.remove('d-none');
        } catch (e) {
            console.error(e);
            alert("Error al conectar con la base de datos");
        }
    }

    async function generarPDF(datos) {
        const { jsPDF } = window.jspdf;
        
        // Llenar la plantilla oculta
        document.getElementById('pdf-nombre').innerText = datos.nombre;
      //  document.getElementById('pdf-curso').innerText = datos.curso;
        document.getElementById('pdf-detalles').innerText = datos.detalles;
      //  document.getElementById('pdf-horas').innerText = datos.horas;
        document.getElementById('pdf-fecha').innerText = datos.fecha;
        document.getElementById('pdf-capacitador').innerText = datos.capacitador;
        
        const element = document.getElementById('certificado-template');
        element.style.display = 'block'; // Mostrar temporalmente para renderizar

        const canvas = await html2canvas(element);
        const imgData = canvas.toDataURL('image/png');
        
        const pdf = new jsPDF('l', 'mm', 'a4'); // Orientación Horizontal (Landscape)
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`Certificado_${datos.curso}_${datos.nombre}.pdf`);
        
        element.style.display = 'none'; // Volver a ocultar
    }
</script>
</body>
</html>